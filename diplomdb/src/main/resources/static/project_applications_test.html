<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Projekt-Bewerbungen Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        label, button { display: block; margin: 8px 0; }
        input { width: 300px; }
        .response { border: 1px solid #ccc; padding: 10px; background: #f9f9f9; white-space: pre-wrap; margin-top: 10px; }
    </style>
</head>
<body>
<!-- Gemeinsamer Header -->
<header style="background: #333; color: #fff; padding: 10px;">
    <nav>
        <a href="/index.html" style="color: #fff; margin-right: 15px;">Home</a>
        <a href="/login_test.html" style="color: #fff; margin-right: 15px;">Login Test</a>
        <a href="/betreuer_test.html" style="color: #fff; margin-right: 15px;">Betreuer Test</a>
        <a href="/projects_test.html" style="color: #fff; margin-right: 15px;">Projekte Test</a>
        <a href="/documents_test.html" style="color: #fff; margin-right: 15px;">Dokumente Test</a>
        <a href="/milestones_test.html" style="color: #fff; margin-right: 15px;">Meilensteine Test</a>
        <a href="/project_applications_test.html" style="color: #fff; margin-right: 15px;">Bewerbungen Test</a>
        <a href="/schueler_test.html" style="color: #fff; margin-right: 15px;">Schüler Test</a>
        <a href="/user_test.html" style="color: #fff;">User Test</a>
    </nav>
    <div id="headerLoginSection">
        <label style="color: #fff;">Username:
            <input type="text" id="headerUsername">
        </label>
        <label style="color: #fff;">Password:
            <input type="password" id="headerPassword">
        </label>
        <button id="headerLoginBtn">Login</button>
    </div>
</header>
<hr>

<h1>Projekt-Bewerbungen Test</h1>

<h2>Bewerbung erstellen</h2>
<label>Projekt-ID:
    <input type="text" id="appProjId">
</label>
<label>sAMAccountName:
    <input type="text" id="appSam">
</label>
<label>Priorität (1-3):
    <input type="text" id="appPriority">
</label>
<label>Team-Mitglieder (kommagetrennt):
    <input type="text" id="appTeam">
</label>
<button id="createAppBtn">Bewerbung erstellen (POST /api/project-applications)</button>

<h2>Bewerbungen abrufen</h2>
<button id="getAppsBtn">GET /api/project-applications</button>

<h2>Bewerbungs-Übersicht (gruppiert)</h2>
<button id="getAppsOverviewBtn">GET /api/project-applications/overview</button>

<h2>Bewerbung finalisieren</h2>
<label>Bewerbung-ID:
    <input type="text" id="finalizeAppId">
</label>
<label>Decision (ACCEPTED/REJECTED):
    <input type="text" id="finalizeDecision">
</label>
<button id="finalizeAppBtn">Finalisieren (PUT /api/project-applications/{id}/finalize)</button>

<h2>Bewerbung löschen</h2>
<label>Bewerbung-ID:
    <input type="text" id="deleteAppId">
</label>
<button id="deleteAppBtn">Löschen (DELETE /api/project-applications/{id})</button>

<h3>Response:</h3>
<pre class="response" id="responseArea"></pre>

<script>
    let csrfToken = null;
    async function getCsrf() {
        if (!csrfToken) {
            const res = await fetch('/api/csrf-token', { method: 'GET', credentials: 'include' });
            const data = await res.json();
            csrfToken = data.csrfToken;
        }
    }
    // Header Login (falls noch nicht erfolgt)
    document.getElementById('headerLoginBtn').addEventListener('click', async () => {
        const username = document.getElementById('headerUsername').value;
        const password = document.getElementById('headerPassword').value;
        const res = await fetch('/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password }),
            credentials: 'include'
        });
        const data = await res.json();
        alert("Login Response: " + JSON.stringify(data, null, 2));
        const csrfRes = await fetch('/api/csrf-token', { method: 'GET', credentials: 'include' });
        const csrfData = await csrfRes.json();
        csrfToken = csrfData.csrfToken;
        alert("CSRF Token: " + csrfToken);
        if(data.status === 'success'){
            document.getElementById('headerLoginSection').style.display = 'none';
        }
    });

    document.getElementById('createAppBtn').addEventListener('click', async () => {
        await getCsrf();
        const projId = parseInt(document.getElementById('appProjId').value, 10);
        const sam = document.getElementById('appSam').value;
        const priority = parseInt(document.getElementById('appPriority').value, 10);
        const team = document.getElementById('appTeam').value.split(',').map(s => s.trim()).filter(s => s);
        const body = { projektId: projId, samAccountName: sam, prioritaet: priority, teamMitglieder: team };
        const res = await fetch('/api/project-applications', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'X-CSRF-TOKEN': csrfToken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
        });
        const data = await res.json();
        document.getElementById('responseArea').textContent = JSON.stringify(data, null, 2);
    });

    document.getElementById('getAppsBtn').addEventListener('click', async () => {
        await getCsrf();
        const res = await fetch('/api/project-applications', {
            method: 'GET',
            credentials: 'include',
            headers: { 'X-CSRF-TOKEN': csrfToken }
        });
        const data = await res.json();
        document.getElementById('responseArea').textContent = JSON.stringify(data, null, 2);
    });

    document.getElementById('getAppsOverviewBtn').addEventListener('click', async () => {
        await getCsrf();
        const res = await fetch('/api/project-applications/overview', {
            method: 'GET',
            credentials: 'include',
            headers: { 'X-CSRF-TOKEN': csrfToken }
        });
        const data = await res.json();
        document.getElementById('responseArea').textContent = JSON.stringify(data, null, 2);
    });

    document.getElementById('finalizeAppBtn').addEventListener('click', async () => {
        await getCsrf();
        const appId = document.getElementById('finalizeAppId').value;
        const decision = document.getElementById('finalizeDecision').value;
        const url = `/api/project-applications/${encodeURIComponent(appId)}/finalize?decision=${encodeURIComponent(decision)}`;
        const res = await fetch(url, {
            method: 'PUT',
            credentials: 'include',
            headers: { 'X-CSRF-TOKEN': csrfToken }
        });
        const data = await res.json();
        document.getElementById('responseArea').textContent = JSON.stringify(data, null, 2);
    });

    document.getElementById('deleteAppBtn').addEventListener('click', async () => {
        await getCsrf();
        const appId = document.getElementById('deleteAppId').value;
        const url = `/api/project-applications/${encodeURIComponent(appId)}`;
        const res = await fetch(url, {
            method: 'DELETE',
            credentials: 'include',
            headers: { 'X-CSRF-TOKEN': csrfToken }
        });
        if (res.status === 204) {
            document.getElementById('responseArea').textContent = "Bewerbung gelöscht.";
        } else {
            const text = await res.text();
            document.getElementById('responseArea').textContent = `Fehler: ${res.status}\n${text}`;
        }
    });
</script>
</body>
</html>
